--ðŸ§± A. Aggregation & Grouping (20 Questions)

--1.Find the total, average, minimum, and maximum credit limit of all customers.

select sum(cust_credit_limit) as total_credit, avg(cust_credit_limit) as avg_credit,
min(cust_credit_limit) as min_credit, max(cust_credit_limit) as max_credit from sh.customers;

--2.Count the number of customers in each income level.

select cust_income_level, count(*) as income_level_population 
from sh.customers 
group by cust_income_level;

--3. Show total credit limit by state and country.

select cust_state_province, country_id,sum(cust_credit_limit) as total_credit
from sh.customers 
group by cust_state_province,country_id;

--4. Display average credit limit for each marital status and gender combination.

select cust_marital_status, cust_gender, avg(cust_credit_limit) as avg_credit_limit
from sh.customers 
group by cust_marital_status, cust_gender;


--5.Find the top 3 states with the highest average credit limit.

select * from
(select cust_state_province , avg(cust_credit_limit) as avg_cust_credit
from sh.customers 
group by cust_state_province
order by avg_cust_credit desc)
where rownum <=3;

--6.Find the country with the maximum total customer credit limit.

select * from (select country_id, sum(cust_credit_limit) as max_limit
from sh.customers 
group by country_id
order by max_limit desc )
where rownum = 1;


--7. Show the number of customers whose credit limit exceeds their state average.

/*select count(*) as cust_population
from sh.customers 
where cust_credit_limit >
(select cust_state_province, 
avg(cust_credit_limit) as avg_cust_credit)
*/

--8.  Calculate total and average credit limit for customers born after 1980.
select sum(cust_credit_limit) as total_credit,
avg(cust_credit_limit) as avg_credit 
from sh.customers
where cust_year_of_birth > 1980;

--9. Find states having more than 50 customers.
 
 select cust_state_province, count(*) as total_population
 from sh.customers 
 group by cust_state_province
 having total_population > 50;


--10.List countries where the average credit limit is higher than the global average.

select country_id, avg(cust_credit_limit) as avg_credit_limit 
from sh.customers 
group by country_id
having avg(cust_credit_limit) > (select avg(cust_credit_limit)from sh.customers);

--11.Calculate the variance and standard deviation of customer credit limits by country.

select country_id, variance(cust_credit_limit) as var_credit, stddev(cust_credit_limit) as std_credit
from sh.customers 
group by country_id;

--12. Find the state with the smallest range (maxâ€“min) in credit limits.

select * from ( select cust_state_province, max(cust_credit_limit) - min(cust_credit_limit) as credit_range
from sh.customers 
group by cust_state_province
order by credit_range desc)
where rownum <= 1;

--13. Show the total number of customers per income level and the percentage contribution of each.

with income_level as (
    select cust_income_level, count(*) as total_income_level
    from sh.customers
    group by cust_income_level)

    select total_income_level,  cust_income_level,
    round((total_income_level*100)/sum(total_income_level)over()) as percentage
    from income_level
    order by percentage desc;
    
--14.For each income level, find how many customers have NULL credit limits.

with inc_level as(
    select cust_income_level
    from sh.customers 
    where cust_credit_limit is null
)
select cust_income_level,  count(*) as total_count
from inc_level
group by cust_income_level;

--15.display countries where the sum of credit limits exceeds 10 million.

select country_id, sum(cust_credit_limit) as cust_credit_limit
from sh.customers 
where cust_credit_limit > 10000000
group by country_id
order by country_id desc;

--16.Find the state that contributes the highest total credit limit to its country.

with rank_as as ( select cust_state_province, country_id, sum(cust_credit_limit) as total_credit,
rank() over (partition by country_id order by sum(cust_credit_limit) desc) as rn
from sh.customers 
group by cust_state_province, country_id)
select * from rank_as where rn = 1;

--17.Show total credit limit per year of birth, sorted by total descending.

select cust_year_of_birth, sum(cust_credit_limit) as sum_credit
from sh.customers 
group by cust_year_of_birth 
order by sum(cust_credit_limit) desc;

--18. Identify customers who hold the maximum credit limit in their respective country.


  with cust_as as (
    select country_id, cust_credit_limit, 
    rank() over (partition by country_id order by cust_credit_limit desc) as rn
    from sh.customers)
    select * from cust_as where rn = 1;


--19. Show the difference between maximum and average credit limit per country.

select country_id, max(cust_credit_limit) - avg(cust_credit_limit) as diff_credit
from sh.customers 
group by country_id;

--20.Display the overall rank of each state based on its total credit limit (using GROUP BY + analytic rank).


with state_rank as (
    select cust_state_province, 
    sum(cust_credit_limit) as sum_credit
    from sh.customers 
    group by cust_state_province
)
select cust_state_province, sum_credit,
rank() over (order by sum_credit desc) as rn
from state_rank
order by rn;



--## ðŸ“Š B. Analytical / Window Functions (30 Questions)

--1. Assign row numbers to customers ordered by credit limit descending.  

select cust_credit_limit, cust_first_name||' '||cust_last_name as names,
row_number() over (order by cust_credit_limit desc) as rn
from sh.customers;


--2. Rank customers within each state by credit limit.  

select cust_state_province, cust_credit_limit, cust_first_name||' '||cust_last_name as names,
rank() over (partition by cust_state_province order by cust_credit_limit desc) as rn_2
from sh.customers;

-- 3. Use DENSE_RANK() to find the top 5 credit holders per country.  

select cust_first_name||' '||cust_last_name as names, cust_credit_limit,
dense_rank() over (order by cust_credit_limit desc) as rn_3
from sh.customers;

-- 4. Divide customers into 4 quartiles based on their credit limit using NTILE(4). 

select  cust_credit_limit,cust_first_name||' '||cust_last_name as names,
ntile(4) over (order by cust_credit_limit desc) as rn_4
from sh.customers;


--5. Calculate a running total of credit limits ordered by customer_id.  

select cust_id,cust_credit_limit,  sum(cust_credit_limit) over (order by cust_id desc) as sum_5
from sh.customers;


--6. Show cumulative average credit limit by country.  

select country_id, avg(cust_credit_limit) over (order by country_id desc) as avg_6
from sh.customers;


--7. Compare each customerâ€™s credit limit to the previous one using LAG().  

select cust_first_name||' '||cust_last_name as name, cust_credit_limit,
lag(cust_credit_limit) over (order by cust_credit_limit desc) as lag_credit 
from sh.customers;


--8. Show next customerâ€™s credit limit using LEAD().  

select cust_first_name||' '||cust_last_name as name, cust_credit_limit,
lead(cust_credit_limit) over (order by cust_credit_limit desc) as lead_credit 
from sh.customers;


--9. Display the difference between each customerâ€™s credit limit and the previous one.  

select cust_first_name||' '||cust_last_name as name, cust_credit_limit,
lag(cust_credit_limit) over (order by cust_credit_limit desc) - cust_credit_limit  as diff_credit 
from sh.customers;

--10. For each country, display the first and last credit limit using FIRST_VALUE() and LAST_VALUE().  

select distinct  country_id, first_value(cust_credit_limit) over (partition by country_id order by cust_credit_limit desc)
 as first_value,last_value(cust_credit_limit) over (partition by country_id order by cust_credit_limit desc) as last_value 
from sh.customers;
-- error


--11. Compute percentage rank (PERCENT_RANK()) of customers based on credit limit.

select cust_first_name||' '||cust_last_name as name, cust_credit_limit,
percent_rank() over (order by cust_credit_limit desc) as lead_credit 
from sh.customers;


--12. Show each customerâ€™s position in percentile (CUME_DIST() function).  

select cust_first_name||' '||cust_last_name as name, cust_credit_limit,
cume_dist() over (order by cust_credit_limit desc) as lead_credit 
from sh.customers;


--13. Display the difference between the maximum and current credit limit for each customer.  

select cust_first_name||' '||cust_last_name as name, cust_credit_limit,
max(cust_credit_limit) over() - cust_credit_limit as credit_max_diff
from sh.customers;

-- 14. Rank income levels by their average credit limit.  

select cust_income_level, avg(cust_credit_limit) as avg_of_income_level,
rank() over (order by avg(cust_credit_limit) desc) as rn
from sh.customers
group by cust_income_level
order by avg_of_income_level;

--15. Calculate the average credit limit over the last 10 customers (sliding window).  

 select cust_first_name||' '||cust_last_name, cust_id, cust_credit_limit,
 avg(cust_credit_limit) over(order by cust_id rows between 9 preceding and current row) as avg_row
 from sh.customers;

--16. For each state, calculate the cumulative total of credit limits ordered by city.  

select cust_state_province, cust_city, cust_credit_limit,cust_id,
sum(cust_credit_limit) over (partition by cust_state_province order by cust_city, cust_id) 
as rn from sh.customers 
order by cust_state_province, cust_city; 

--17. Find customers whose credit limit equals the median credit limit (use PERCENTILE_CONT(0.5)).  
select cust_id, cust_credit_limit
from sh.customers
where cust_credit_limit = (select percentile_cont(0.5) within
group(order by cust_credit_limit asc));

--18. Display the highest 3 credit holders per state using ROW_NUMBER() and PARTITION BY.

select * from (select cust_first_name||' '||cust_last_name, cust_id, cust_credit_limit,
row_number() over (partition by cust_state_province order by cust_credit_limit desc) as rn
from sh.customers) where rn <= 3; 

--19. Identify customers whose credit limit increased compared to previous row (using LAG).  

select * from (select cust_first_name||' '||cust_last_name, cust_id, cust_credit_limit,
lag(cust_credit_limit) over (order by cust_id ) - cust_credit_limit as lag_res
from sh.customers) where lag_res >= 1;


--20. Calculate moving average of credit limits with a window of 3.  

select cust_id, cust_first_name||' '||cust_last_name as names, cust_credit_limit,
avg(cust_credit_limit) over (order by cust_id rows between 2 preceding and current row) as avg_20
from sh.customers;


 -- 21. Show cumulative percentage of total credit limit per country.  

with cum_per as (select cust_id, country_id, 
sum(cust_credit_limit) over (partition by country_id order by cust_id) as cumulative_total,
sum(cust_credit_limit) over (partition by country_id) as country_total
from sh.customers)
select
cust_id,
country_id,
cumulative_total,
country_total,
round(((cumulative_total*100)/country_total),2) as cum_percentage
from cum_per;

--22. Rank customers by age (derived from CUST_YEAR_OF_BIRTH).  

select cust_year_of_birth, cust_first_name||' '||cust_last_name as names,
rank() over (order by cust_year_of_birth desc) as rn
from sh.customers;


--23. Calculate difference in age between current and previous customer in the same state. 

select cust_year_of_birth, cust_first_name||' '||cust_last_name as names,
lag(cust_year_of_birth) over (order by cust_id desc) - cust_year_of_birth as diff_age
from sh.customers;

-- 24. Use RANK() and DENSE_RANK() to show how ties are treated differently.  
select cust_year_of_birth, cust_first_name||' '||cust_last_name as names,
rank() over (order by cust_year_of_birth desc) as rank_24,
dense_rank() over (order by cust_year_of_birth desc) as dense_rank_24
from sh.customers;

--25. Compare each stateâ€™s average credit limit with country average using window partition.  
with avg_credit as (select country_id, cust_state_province ,
avg(cust_credit_limit) as state_avg,
avg(avg(cust_credit_limit)) over (partition by country_id) as country_avg
from sh.customers
group by cust_state_province, country_id)
select
country_id,
cust_state_province,
state_avg,
country_avg,
country_avg - state_avg as diff_avg_credit
from avg_credit;

--26. Show total credit per state and also its rank within each country.

with state_sum as (select country_id, cust_state_province,
sum(cust_credit_limit) as state_sum
from sh.customers
group by country_id, cust_state_province)
select 
country_id,
cust_state_province,
state_sum,
rank() over (partition by country_id order by state_sum desc) as rank_avg
from state_sum;
